#ifdef GL_ES
precision mediump float;
#endif
uniform float time;uniform vec2 resolution;vec3 a;float b;
#define time        stemu_time

#define resolution  stemu_resolution
float c(float d,float e,float f){float g=clamp(0.5+0.5*(e-d)/f,0.0,1.0);return mix(e,d,g)-f*g*(1.0-g);}float h(vec3 i,vec3 d,vec3 e,float j){vec3 k=i-d,ba=e-d;float g=clamp(dot(k,ba)/dot(ba,ba),0.0,1.0);return length(k-ba*g)-j;}float l(float d,float e,float f){return -c(-d,-e,f);}mat2 m(float d){return mat2(cos(d),sin(d),-sin(d),cos(d));}float n(vec3 i){vec3 o=i;float p=1e4;i.y-=1.5;o=i;i-=vec3(-.5,-.6,-.9);i.yz=m(-.7)*i.yz;i.xz=m(0.1)*i.xz;p=min(p,-c(i.y,-(length(i*vec3(1.6,1,1))-.64),.2));i=o;o=i;i-=vec3(.55,-.8,0.4);i.x=-i.x;i.yz=m(1.4)*i.yz;p=min(p,-c(i.y,-(length(i*vec3(1.6,1,1))-.73),.2));i=o;return p;}float q(vec3 i){vec3 o=i;float p=n(i);p=min(p,i.y);i.y-=1.5;p=min(p,length(i)-1.);o=i;i-=vec3(.66,.7,0);i.xz=m(-0.1)*i.xz;p=c(p,(length(i*vec3(1.8,1,1))-.58),.07);i=o;o=i;i-=vec3(-.75,0.2,0);p=c(p,(length(i*vec3(1,1.5,1))-.54),.03);i=o;i.y-=.11;float r=l(i.z+.84,l(l(i.x-.2,i.y-.075,.2),dot(i,vec3(.7071,-.7071,0))-.1,.08),.04);i.x=-i.x;r=l(r,l(i.z+.84,l(l(i.x-.2,i.y-.075,.2),dot(i,vec3(.7071,-.7071,0))-.1,.08),.01),.13);p=l(p,-r,.012);i=o;p=c(p,length((i-vec3(0,.03,-.75))*vec3(1,1,1))-.16,.01);return min(p,10.);}vec3 s(vec3 i){vec3 t=vec3(1e-3,0,0);float p=q(i);return normalize(vec3(q(i+t.xyy)-q(i-t.xyy),q(i+t.yxy)-q(i-t.yxy),q(i+t.yyx)-q(i-t.yyx)));}float u(vec3 i,vec3 v){const int w=4;const float x=0.15;float d=0.0;float y=4.;for(int z=1;z<=w;z++){float p=(float(z)/float(w))*x;d+=y*(p-q(i+v*p));y*=0.5;}return clamp(1.0-d,0.0,1.0);}float aa(float ab){return cos(ab-sin(ab)/3.);}float ac(vec2 i){float d=atan(i.y,i.x)+b/3.;float ad=pow(length(i),.8);float ae=1.-smoothstep(0.,(3.-aa(d*5.*2.))*.02,ad-.5+aa(d*5.)*.1);return ae;}void af(out vec4 ag,in vec2 ah){vec2 ai=ah/a.xy;float aj=cos(b)*.1;vec2 ak=ai*2.-1.;ak.y*=a.y/a.x;vec3 al=vec3(0.,1.4,4.);vec3 am=normalize(vec3(ak.xy,-1.3));am.xz=mat2(cos(aj),sin(aj),sin(aj),-cos(aj))*am.xz;al.xz=mat2(cos(aj),sin(aj),sin(aj),-cos(aj))*al.xz;float an=20.;float ao=0.,p=0.;for(int z=0;z<80;++z){p=q(al+am*ao);if(p<1e-4)break;if(ao>10.)break;ao+=p*.9;}ao=min(ao,10.0);vec3 ap=al+am*ao;vec3 v=s(ap);float aq=5e-3;vec3 ar=normalize(vec3(2,4,-4));for(int z=0;z<20;++z){p=q(ap+ar*aq);if(p<1e-5)break;if(aq>5.)break;aq+=p*2.;}vec3 as=vec3(u(ap,v));float at=mix(.85,1.,step(5.,aq));as*=mix(.3,1.,.5+.5*v.y);if(ap.y<1e-3)as*=mix(mix(vec3(1,.5,.7),vec3(1),.4)*.6,vec3(1),smoothstep(0.,1.6,length(ap.xz)));vec3 au=vec3(1);vec3 av=vec3(0);au*=vec3(1.15,.3,.41)*1.4;au+=.4*mix(1.,0.,smoothstep(0.,1.,length(ap.xy-vec2(0.,1.9))));au+=.5*mix(1.,0.,smoothstep(0.,.5,length(ap.xy-vec2(.7,2.5))));au+=.36*mix(1.,0.,smoothstep(0.,.5,length(ap.xy-vec2(-1.1,1.8))));if(ap.y<1e-3)au=vec3(.6,1,.6);au*=mix(vec3(1,.3,.2),vec3(1),smoothstep(.97,.99,length(ap-vec3(0,1.5,0))));au=mix(vec3(1.,.05,.1),au,smoothstep(0.,0.01,n(ap)));au+=.2*mix(1.,0.,smoothstep(0.,.2,length(ap.xy-vec2(-0.5,1.4))));au+=.12*mix(1.,0.,smoothstep(0.,.25,length(ap.xy-vec2(0.57,.3))));au+=vec3(.25,1.,.25)*smoothstep(-.3,1.7,-ap.y+1.)*max(0.,-v.y)*.7;vec3 aw=ap;ap.y-=1.5;ap.x=abs(ap.x);au*=mix(vec3(1,.5,.5),vec3(1),smoothstep(.1,.15,length((ap.xy-vec2(.4,.2))*vec2(1,1.65))));ap.xy-=vec2(.16,.45);ap.xy*=.9;aw=ap;ap.y=pow(abs(ap.y),1.4)*sign(ap.y);au*=smoothstep(.058,.067,length((ap.xy)*vec2(.9,.52)));ap=aw;ap.y+=.08;ap.y-=pow(abs(ap.x),2.)*16.;av+=vec3(.1,.5,1.)*(1.-smoothstep(.03,.036,length((ap.xy)*vec2(.7,.3))))*max(0.,-ap.y)*10.;ap=aw;ap.y-=.12;av+=vec3(1)*(1.-smoothstep(.03,.04,length((ap.xy)*vec2(1.,.48))));au+=pow(clamp(1.-dot(-am,v),0.,.9),4.)*.5;vec3 ax=vec3(1.15,.3,.41)*.9;ak.x+=.6+b/50.;ak.y+=cos(floor(ak.x*2.)*3.)*.1+.2;ak.x=mod(ak.x,.5)-.25;ax=mix(ax,vec3(1.,1.,.5),.1*ac((ak-vec2(0.,.6))*8.)*smoothstep(9.,10.,ao));au=mix(au,ax,smoothstep(.9,10.,ao));ag.rgb=mix(vec3(.15,0,0),vec3(1),as)*at*au*1.1;ag.rgb+=av;ag.rgb=pow(ag.rgb,vec3(1./2.4));ag.a=1.0;}
#undef time

#undef resolution
void main(void){a=vec3(resolution,0.0);b=time;af(gl_FragColor,gl_FragCoord.xy);}